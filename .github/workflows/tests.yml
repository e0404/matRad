# This is a basic workflow to help you get started with Actions
name: Tests
# Controls when the action will run. 
on: [push, pull_request, workflow_dispatch]  
jobs:
  test-matlab-stable: #Matlab test Job for supported Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Checks-out repository under $GITHUB_WORKSPACE
      - name: Get MOxUnit
        uses: actions/checkout@v4
        with:
          repository: MOxUnit/MOxUnit
          path: MOxUnit
      # Install MATLAB
      - name: Install MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2022b
      # Runs test command
      - name: Run Tests
        uses: matlab-actions/run-command@v2
        with:
          command: back=cd('MOxUnit/MOxUnit'); moxunit_set_path; cd(back); matRad_rc; moxunit_runtests('test','-junit_xml_file','testresults.xml'); exit(double(~ans))
      - name: Upload Report
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: test-results
          path: testresults.xml
  test-matlab-latest: #Matlab test Job for latest Matlab release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Checks-out repository under $GITHUB_WORKSPACE
      - name: Get MOxUnit
        uses: actions/checkout@v4
        with:
          repository: MOxUnit/MOxUnit
          path: MOxUnit
      # Install MATLAB
      - name: Install MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: latest
      # Runs test command
      - name: Run Tests
        uses: matlab-actions/run-command@v2
        with:
          command: back=cd("MOxUnit/MOxUnit"); moxunit_set_path; cd(back); matRad_rc; moxunit_runtests test; exit(double(~ans))
  test-octave-6: #Octave test Job
    runs-on: ubuntu-22.04 # We use Ubuntu-22.04 because it has Octave 6.4
    steps:
      - uses: actions/checkout@v4 # Checks-out repository under $GITHUB_WORKSPACE
      - name: Get MOxUnit
        uses: actions/checkout@v4
        with:
          repository: MOxUnit/MOxUnit
          path: MOxUnit
      - name: Install OCTAVE
        run: | 
          sudo apt update
          sudo apt-get install -y gdb gfortran fonts-freefont-otf gnuplot-x11 libgdcm-dev octave liboctave-dev
      - name: Prepare Test Environment
        run: |
          sudo chmod +x .github/before_install_linux.sh
          sudo .github/before_install_linux.sh
      - name: Run Tests 
        run: xvfb-run -a .github/runtests.sh octave-cli
        # uses: GabrielBB/xvfb-action@v1 #For Headless tests
        # with:
        #   run: .github/runtests.sh octave-cli
      - name: Upload logs if test fails
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: Test Log
          path: runtests.log
            
